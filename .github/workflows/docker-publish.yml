name: Build and Publish Docker Images

env:
  VERSION: 2.21.2
  PGVERSION: 15
  DEBIANRELEASE: bookworm
  DOCKERREVISION: 2

on:
  push:
    branches: [stable]

jobs:
  build-and-push-pg:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Common setup
        uses: ./.github/actions/docker-common
        with:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          DOCKER_IMAGE: yadd/lemonldap-ng-pg-database
          DIRNAME: ./pg

  build-and-push-base:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Common setup
        uses: ./.github/actions/docker-common
        with:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          DOCKER_IMAGE: yadd/lemonldap-ng-base
          DIRNAME: ./base

  build-and-push-portal:
    needs: build-and-push-base
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Common setup
        uses: ./.github/actions/docker-common
        with:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          DOCKER_IMAGE: yadd/lemonldap-ng-portal
          DIRNAME: ./portal

  build-and-push-portal-hiperf:
    needs: build-and-push-base
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Common setup
        uses: ./.github/actions/docker-common
        with:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          DOCKER_IMAGE: yadd/lemonldap-ng-portal
          DIRNAME: ./uwsgi-portal
          IMAGE_SUFFIX2: "-hiperf"

  build-and-push-pubsub-server:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Common setup
        uses: ./.github/actions/docker-common
        with:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          DOCKER_IMAGE: yadd/lemonldap-ng-pubsub-server
          DIRNAME: ./webpubsub

  build-and-push-cron:
    needs: build-and-push-base
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Common setup
        uses: ./.github/actions/docker-common
        with:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          DOCKER_IMAGE: yadd/lemonldap-ng-cron
          DIRNAME: ./cron

  build-and-push-cron-task:
    needs: build-and-push-base
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Common setup
        uses: ./.github/actions/docker-common
        with:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          DOCKER_IMAGE: yadd/lemonldap-ng-cron-task
          DIRNAME: ./cron-task

  build-and-push-sessions-backup:
    needs: build-and-push-base
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Common setup
        uses: ./.github/actions/docker-common
        with:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          DOCKER_IMAGE: yadd/lemonldap-ng-sessions-backup
          DIRNAME: ./sessions-backup

  build-and-push-manager:
    needs: build-and-push-base
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Common setup
        uses: ./.github/actions/docker-common
        with:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          DOCKER_IMAGE: yadd/lemonldap-ng-manager
          DIRNAME: ./manager

  build-and-push-full:
    needs: build-and-push-portal
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Common setup
        uses: ./.github/actions/docker-common
        with:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          DOCKER_IMAGE: yadd/lemonldap-ng-full
          DIRNAME: ./full

  build-and-push-ssoaas-fastcgi-server:
    needs: build-and-push-base
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Common setup
        uses: ./.github/actions/docker-common
        with:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          DOCKER_IMAGE: yadd/lemonldap-ng-ssoaas-fastcgi-server
          DIRNAME: ./ssoaas-fastcgi-server

  build-and-push-base-no-s6:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Common setup
        uses: ./.github/actions/docker-common
        with:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          DOCKER_IMAGE: yadd/lemonldap-ng-base
          DIRNAME: ./base-no-s6
          IMAGE_SUFFIX: "-no-s6"

  build-and-push-portal-no-s6:
    needs: build-and-push-base-no-s6
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Common setup
        uses: ./.github/actions/docker-common
        with:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          DOCKER_IMAGE: yadd/lemonldap-ng-portal
          DIRNAME: ./portal
          IMAGE_SUFFIX: "-no-s6"

  build-and-push-portal-hiperf-no-s6:
    needs: build-and-push-base-no-s6
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Common setup
        uses: ./.github/actions/docker-common
        with:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          DOCKER_IMAGE: yadd/lemonldap-ng-portal
          DIRNAME: ./uwsgi-portal
          IMAGE_SUFFIX: "-no-s6"
          IMAGE_SUFFIX2: "-hiperf"

  build-and-push-cron-no-s6:
    needs: build-and-push-base-no-s6
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Common setup
        uses: ./.github/actions/docker-common
        with:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          DOCKER_IMAGE: yadd/lemonldap-ng-cron
          DIRNAME: ./cron
          IMAGE_SUFFIX: "-no-s6"

  build-and-push-cron-task-no-s6:
    needs: build-and-push-base-no-s6
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Common setup
        uses: ./.github/actions/docker-common
        with:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          DOCKER_IMAGE: yadd/lemonldap-ng-cron-task
          DIRNAME: ./cron-task
          IMAGE_SUFFIX: "-no-s6"

  build-and-push-sessions-backup-no-s6:
    needs: build-and-push-base-no-s6
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Common setup
        uses: ./.github/actions/docker-common
        with:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          DOCKER_IMAGE: yadd/lemonldap-ng-sessions-backup
          DIRNAME: ./sessions-backup
          IMAGE_SUFFIX: "-no-s6"

  build-and-push-manager-no-s6:
    needs: build-and-push-base-no-s6
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Common setup
        uses: ./.github/actions/docker-common
        with:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          DOCKER_IMAGE: yadd/lemonldap-ng-manager
          DIRNAME: ./manager
          IMAGE_SUFFIX: "-no-s6"

  build-and-push-full-no-s6:
    needs: build-and-push-portal-no-s6
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Common setup
        uses: ./.github/actions/docker-common
        with:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          DOCKER_IMAGE: yadd/lemonldap-ng-full
          DIRNAME: ./full
          IMAGE_SUFFIX: "-no-s6"

  build-and-push-ssoaas-fastcgi-server-no-s6:
    needs: build-and-push-base-no-s6
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Common setup
        uses: ./.github/actions/docker-common
        with:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          DOCKER_IMAGE: yadd/lemonldap-ng-ssoaas-fastcgi-server
          DIRNAME: ./ssoaas-fastcgi-server
          IMAGE_SUFFIX: "-no-s6"
