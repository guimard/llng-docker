!function(){"use strict";var d={_whatToTrace:[function(e,t){return`groupBy=substr(${e},1)`},function(e,t){return e+`=${t}*&groupBy=`+e},function(e,t){return e+"="+t}],ipAddr:[function(e,t){return`groupBy=net(${e},16,1)`},function(e,t){return t.match(/:/)||(t+="."),e+`=${t}*&groupBy=net(${e},32,2)`},function(e,t){return t.match(/:/)||(t+="."),e+`=${t}*&groupBy=net(${e},48,3)`},function(e,t){return t.match(/:/)||(t+="."),e+`=${t}*&groupBy=net(${e},128,4)`},function(e,t){return e+`=${t}&groupBy=_whatToTrace`},function(e,t,n){return n.replace(/\&groupBy.*$/,"")+"&_whatToTrace="+t}],_startTime:[function(e,t){return`groupBy=substr(${e},8)`},function(e,t){return e+`=${t}*&groupBy=substr(${e},10)`},function(e,t){return e+`=${t}*&groupBy=substr(${e},11)`},function(e,t){return e+`=${t}*&groupBy=substr(${e},12)`},function(e,t){return e+`=${t}*&groupBy=_whatToTrace`},function(e,t,n){return n.replace(/\&groupBy.*$/,"")+"&_whatToTrace="+t}],doubleIp:[function(e,t){return e},function(e,t){return`_whatToTrace=${t}&groupBy=ipAddr`},function(e,t,n){return n.replace(/\&groupBy.*$/,"")+"&ipAddr="+t}],_session_uid:[function(e,t){return`groupBy=substr(${e},1)`},function(e,t){return e+`=${t}*&groupBy=`+e},function(e,t){return e+"="+t}]},f={_whatToTrace:function(e,t,n,o){return console.debug("overScheme => level",n,"over",o),!(t.length>=n+o)&&1===n&&t.length>o?e+`=${t}*&groupBy=substr(${e},${n+o+1})`:null},ipAddr:function(e,t,n,o){return console.debug("overScheme => level",n,"over",o),0<n&&n<4&&!t.match(/^\d+\.\d/)&&o<2?e+`=${t}*&groupBy=net(${e},${16*n+4*(o+1)},${1+n+o})`:null},_startTime:function(e,t,n,o){return console.debug("overScheme => level",n,"over",o),3<n?e+`=${t}*&groupBy=substr(${e},${10+n+o})`:null},_session_uid:function(e,t,n,o){return console.debug("overScheme => level",n,"over",o),1===n&&t.length>o?e+`=${t}*&groupBy=substr(${e},${n+o+1})`:null}},O={dateTitle:["_utime","_startTime","_updateTime","_lastAuthnUTime","_lastSeen"],connectionTitle:["ipAddr","_timezone","_url"],authenticationTitle:["_session_id","_user","_password","authenticationLevel"],modulesTitle:["_auth","_userDB","_passwordDB","_issuerDB","_authChoice","_authMulti","_userDBMulti","_2f"],saml:["_idp","_idpConfKey","_samlToken","_lassoSessionDump","_lassoIdentityDump"],groups:["groups","hGroups"],ldap:["dn"],OpenIDConnect:["_oidc_id_token","_oidc_OP","_oidc_access_token","_oidc_refresh_token","_oidc_access_token_eol","_oidcConnectedRP","_oidcConnectedRPIDs"],sfaTitle:["_2fDevices"],oidcConsents:["_oidcConsents"]},i={session:[{title:"deleteSession",icon:"trash"},{title:"globalLogout",icon:"trash"}],home:[]};angular.module("llngSessionsExplorer",["ui.tree","ui.bootstrap","llApp"]).controller("SessionsExplorerCtrl",["$scope","$translator","$location","$q","$http",function(M,t,r,e,o){var c,n,p;return M.links=links,M.menulinks=menulinks,M.staticPrefix=staticPrefix,M.scriptname=scriptname,M.formPrefix=formPrefix,M.impPrefix=impPrefix,M.sessionTTL=sessionTTL,M.availableLanguages=availableLanguages,M.waiting=!0,M.showM=!1,M.showT=!0,M.data=[],M.currentScope=null,M.currentSession=null,M.menu=i,M.translateP=t.translateP,M.translate=t.translate,M.translateTitle=function(e){return t.translateField(e,"title")},p="global",M.menuClick=function(e){if(e.popup)window.open(e.popup);else switch(e.action||(e.action=e.title),typeof e.action){case"function":e.action(M.currentNode,M);break;case"string":M[e.action]();break;default:console.warn("Unknown action type",typeof e.action)}return M.showM=!1},M.deleteOIDCConsent=function(e,t){var i=document.querySelectorAll(".data-"+t);return M.waiting=!0,o.delete(`${scriptname}sessions/OIDCConsent/${p}/${M.currentSession.id}?rp=${e}&epoch=`+t).then(function(e){var t,n,o,r;for(M.waiting=!1,r=[],n=0,o=i.length;n<o;n++)t=i[n],r.push(t.remove());return r},function(e){return M.waiting=!1}),M.showT=!1},M.deleteSession=function(){return M.waiting=!0,o.delete(scriptname+`sessions/${p}/`+M.currentSession.id).then(function(e){return M.currentSession=null,M.currentScope.remove(),M.waiting=!1},function(e){return M.waiting=!1})},M.globalLogout=function(){return M.waiting=!0,o.post(scriptname+`sessions/glogout/${p}/`+M.currentSession.id).then(function(e){return M.currentSession=null,M.currentScope.remove(),M.waiting=!1},function(e){return M.waiting=!1})},M.stoggle=function(e){var t=e.$modelValue;return 0===t.nodes.length&&M.updateTree(t.value,t.nodes,t.level,t.over,t.query,t.count),e.toggle()},M.displaySession=function(e){var t,n=function(p){var e,t,n,o,r,i,s,u,l,a,c,d,f,g,h,_,$,m,y,T,v,w,S,b,B,D,L,P,C,A,k,x,R,I,E=function(e,t){var n,o,r,i,s,u,l=[],a=new RegExp(e),c="";for(o in p)s=p[o],o.match(a)&&s&&(c+=s+`:${o},`,delete p[o]);if(c){for((i=(c=c.replace(/,$/,"")).split(",")).sort(),i.reverse(),n=0,r=i.length;n<r;n++)u=i[n].split(":"),l.push({title:u[1],value:M.localeDate(u[0])});return L.push({title:t,nodes:l})}},H=p._utime;for(c in p)(I=p[c])?("string"==typeof p&&I.match(/; /)&&(p[c]=I.split("; ")),"object"!=typeof p[c]&&("_password".match(new RegExp("\b"+c+"\b"))?p[c]="********":c.match(/^(_utime|_lastAuthnUTime|_lastSeen|notification)$/)?p[c]=M.localeDate(I):c.match(/^(_startTime|_updateTime)$/)&&(p[c]=M.strToLocaleDate(I)))):delete p[c];for(o in L=[],O){for(A=[],u=0,f=(n=O[o]).length;u<f;u++){if(t=n[u],p[t])if("_2fDevices"===t&&p[t]){if(0<(e=JSON.parse(p[t])).length)for(A.push({title:"type",value:"name",epoch:"date",td:"0"}),l=0,g=e.length;l<g;l++){for(c in P=e[l])I=P[c],"type"===c&&(x=I),"name"===c&&(T=I),"epoch"===c&&(s=I);A.push({title:x,value:T,epoch:s,td:"1"})}}else if(p[t].toString().match(/"rp":\s*"[\w-]+"/))for(A.push({title:"RP",value:"scope",epoch:"date",td:"0"}),a=0,h=(e=JSON.parse(p[t])).length;a<h;a++){for(c in w=e[a])I=w[c],"rp"===c&&(x=I),"scope"===c&&(T=I),"epoch"===c&&(s=I);A.push({title:x,value:T,epoch:s,td:"2"})}else p[t].toString().match(/\w+/)&&A.push({title:t,value:p[t],epoch:""});delete p[t]}0<A.length&&L.push({title:`__${o}__`,nodes:A})}if(E("^openid","OpenID"),E("^notification_(.+)","__notificationsDone__"),p._loginHistory){if(R=[],p._loginHistory.successLogin)for(y=0,_=(B=p._loginHistory.successLogin).length;y<_;y++){for(c in r="",d=B[y])I=d[c],c.match(/^(_utime|ipAddr|error)$/)||(r+=`, ${c} : `+I);(k=r.split(", ")).sort(),r=k.join(", "),R.push({t:d._utime,title:M.localeDate(d._utime),value:`Success (IP ${d.ipAddr})`+r})}if(p._loginHistory.failedLogin)for(v=0,$=(D=p._loginHistory.failedLogin).length;v<$;v++){for(c in r="",d=D[v])I=d[c],c.match(/^(_utime|ipAddr|error)$/)||(r+=`, ${c} : `+I);(k=r.split(", ")).sort(),r=k.join(", "),R.push({t:d._utime,title:M.localeDate(d._utime),value:`Error ${d.error} (IP ${d.ipAddr})`+r})}delete p._loginHistory,R.sort(function(e,t){return t.t-e.t}),L.push({title:"__loginHistory__",nodes:R})}for(c in R=[],p)I=p[c],R.push({title:c,value:I});for(R.sort(function(e,t){return e.title>t.title?1:e.title<t.title?-1:0}),b=[],C=[],S=0,m=R.length;S<m;S++)((i=R[S]).title.match(new RegExp("^"+M.impPrefix+".+$"))?(console.debug(i,"-> real attribute"),b):C).push(i);return R=C.concat(b),L.push({title:"__attributesAndMacros__",nodes:R}),{_utime:H,nodes:L}};return M.currentScope=e,t=e.$modelValue.session,o.get(scriptname+`sessions/${p}/`+t).then(function(e){return M.currentSession=n(e.data),M.currentSession.id=t}),M.showT=!1},M.localeDate=function(e){return new Date(1e3*e).toLocaleString()},M.isValid=function(e,t){var n=r.path(),o=Date.now()/1e3;return console.debug("Path",n),console.debug("Session epoch",e),console.debug("Current date",o),console.debug("Session TTL",sessionTTL),n=o-e<sessionTTL||r.path().match(/^\/persistent/),"msg"===t?(console.debug("Return msg"),n?"info":"warning"):"style"===t?(console.debug("Return style"),n?{}:{color:"#627990","font-style":"italic"}):(console.debug("Return isValid"),n)},M.strToLocaleDate=function(e){var t=e.match(/^(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})$/);return t.length?new Date(`${t[1]}-${t[2]}-${t[3]}T${t[4]}:${t[5]}:`+t[6]).toLocaleString():e},M.getLanguage=function(e){return M.lang=e,M.form="white",M.init(),M.showM=!1},M.$on("$locationChangeSuccess",function(e,t,n){t=t.match(/#!?\/(\w+)/);return p="global",null===t?M.type="_whatToTrace":t[1].match(/^(persistent|offline)$/)?(p=RegExp.$1,M.type="_session_uid"):M.type=t[1],M.init()}),c=0,M.updateTree=function(r,i,s,u,e,t){var l,a;if(M.waiting=!0,a=d[M.type]||("_updateTime"===M.type?d._startTime:d._whatToTrace),l=a[s](M.type,r,e),25<t&&f[M.type]&&(t=f[M.type](M.type,r,s,u,e))?(u++,l=t,s-=1):u=0,o.get(scriptname+`sessions/${p}?`+l).then(function(e){var t,n,o=e.data;if(o.result){for(t=0;t<o.values.length;t++)n=o.values[t],c++,n.id="node"+c,s<a.length-1&&(n.nodes=[],n.level=s+1,n.query=l,n.over=u,M.type.match(/^(?:start|update)Time$/))&&(n.title=n.value.replace(/^(\d{8})(\d{2})(\d{2})$/,"$2:$3").replace(/^(\d{8})(\d{2})(\d)$/,"$2:$30").replace(/^(\d{8})(\d{2})$/,"$2h").replace(/^(\d{4})(\d{2})(\d{2})/,"$1-$2-$3")),i.push(n);""===r&&(M.total=o.total)}return M.waiting=!1},function(e){return M.waiting=!1}),console.debug("Selection",p),M.navssoStyle={color:"#777"},M.offlineStyle={color:"#777"},M.persistentStyle={color:"#777"},"global"===p&&(M.navssoStyle={color:"#333"}),"offline"===p&&(M.offlineStyle={color:"#333"}),"persistent"===p)return M.persistentStyle={color:"#333"}},M.init=function(){return M.waiting=!0,M.data=[],M.currentScope=null,M.currentSession=null,e.all([t.init(M.lang),M.updateTree("",M.data,0,0)]).then(function(){return M.waiting=!1},function(e){return M.waiting=!1}),M.activeModule="sessions",M.myStyle={color:"#ffb84d"}},n=r.path().match(/^\/(\w+)/),M.type=n?n[1]:"_whatToTrace"}])}();